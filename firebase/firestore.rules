rules_version = '2';

// Firestore Security Rules for Pair Up Events
// These rules control access to data stored in Firestore

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      // Require authentication
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ─────────── USER PROFILES ───────────
    // Path: users/{userId}
    // Private user profiles, only accessible to the authenticated user
    match /users/{userId} {
      // Basic access: users can read and create their own profile
      allow read, create: if isOwner(userId);
      
      // Profile updates: owners can update except for immutable fields
      allow update: if isOwner(userId) && isValidProfileUpdate();
      
      // Deletion handled by backend only
      allow delete: if false;
    }

    // ─────────── PUBLIC PROFILES ───────────
    // Path: publicProfiles/{userId}
    // Public-facing user profiles, accessible by all authenticated users
    match /publicProfiles/{userId} {
      // Anyone authenticated can read public profiles
      allow read: if isAuthenticated();
      
      // Only the profile owner can create/update their public profile
      allow create, update: if isOwner(userId);
      
      // No deletion allowed (handled by backend)
      allow delete: if false;
    }

    // ─────────── DRAFT EVENTS ───────────
    // Path: users/{userId}/ownEvents/{eventId}
    // Draft events created by users during event creation flow
    match /users/{userId}/ownEvents/{eventId} {
      // Only the event owner can read and create their own draft events
      // Allow public read for shared events (via invite links)
      allow read: if isOwner(userId) || isValidInviteAccess(eventId);
      allow create: if isOwner(userId);

      // Only the event owner can update their own draft events
      // Chat history is now stored as an array field in the draft event document
      allow update: if isOwner(userId) && isValidDraftUpdate();

      // Soft deletion handled by setting isDeleted flag (no hard delete)
      allow delete: if false;
    }

    // ─────────── INVITE CODES ───────────
    // Path: inviteCodes/{inviteCode}
    // Invite codes for sharing events with others
    match /inviteCodes/{inviteCode} {
      // Anyone can read invite codes (for validation)
      allow read: if true;

      // Only authenticated users can create invite codes
      allow create: if isAuthenticated();

      // Only the creator can mark it as used
      allow update: if isAuthenticated();

      // No deletion allowed
      allow delete: if false;
    }

    // ─────────── RULE FUNCTIONS ───────────
    function isValidProfileUpdate() {
      // Prevents tampering with system fields
      // Email and createdAt cannot be changed once set
      let emailUnchanged = !('email' in request.resource.data.keys()) || 
                          request.resource.data.email == resource.data.email;
      let createdAtUnchanged = !('createdAt' in request.resource.data.keys()) || 
                              request.resource.data.createdAt == resource.data.createdAt;
      return emailUnchanged && createdAtUnchanged;
    }

    function isValidDraftUpdate() {
      // Allow chatHistory array updates
      // Validate that chatHistory is a list if present, with reasonable size limit
      return !('chatHistory' in request.resource.data) ||
             (request.resource.data.chatHistory is list &&
              request.resource.data.chatHistory.size() <= 1000);
    }

    function isValidInviteAccess(eventId) {
      // This is a placeholder for invite validation logic
      // In practice, you would check if the request includes a valid invite code
      // For now, we'll allow read access if the event has shareStatus = 'shared'
      // The actual validation will happen in the application layer
      return resource.data.shareStatus == 'shared';
    }

    // Deny all other access by default
  }
}
