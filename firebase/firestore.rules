rules_version = '2';

// Firestore Security Rules for Pair Up Events
// These rules control access to data stored in Firestore

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // User Profiles
    // Path: users/{userId}
    match /users/{userId} {
      // ─────────── BASIC ACCESS ───────────
      allow read, create: if request.auth.uid == userId;
      allow delete: if false; // handled by backend only

      // ─────────── PROFILE UPDATES ───────────
      // Owners can update their profile except for immutable fields
      allow update: if request.auth.uid == userId
        && isValidProfileUpdate();

      // ─────────── INVITES & ACCEPTANCE ───────────
      // Owners can create or revoke invites
      // Other users can accept valid ones in a transaction
      allow update: if isValidDuoInviteUpdate(userId);

      // ─────────── FALLBACK ───────────
      allow update: if false;
    }

    // ─────────── PUBLIC PROFILES ───────────
    match /public_profiles/{userId} {
      // Anyone can read public profiles
      allow read: if request.auth != null;

      // Only the profile owner can create/update their public profile
      allow create, update: if request.auth.uid == userId;

      // No deletion allowed (handled by backend)
      allow delete: if false;
    }

    // ─────────── USER EVENTS SUBCOLLECTION (DRAFT EVENTS) ───────────
    // Path: users/{userId}/events/{eventId}
    // Stores draft events with conversation history during event creation
    match /users/{userId}/events/{eventId} {
      // Only the owner can access their draft events
      allow read, write: if isOwner(userId);
    }

    // Events
    // Path: events/{eventId}
    match /events/{eventId} {
      // Anyone authenticated can read published events
      allow read: if isAuthenticated() && resource.data.status == 'published';

      // Event creators can read their own draft events
      allow read: if isAuthenticated() && resource.data.createdBy == request.auth.uid;

      // Authenticated users can create events
      allow create: if isAuthenticated()
                    && request.resource.data.createdBy == request.auth.uid;

      // Only the creator can update their events
      allow update: if isAuthenticated()
                    && resource.data.createdBy == request.auth.uid;

      // Only the creator can delete their events
      allow delete: if isAuthenticated()
                    && resource.data.createdBy == request.auth.uid;
    }

    // Draft Events (in-progress event creation)
    // Path: draftEvents/{userId}/drafts/{draftId}
    match /draftEvents/{userId}/drafts/{draftId} {
      // Only the owner can read their drafts
      allow read: if isOwner(userId);

      // Only the owner can create/update/delete their drafts
      allow write: if isOwner(userId);
    }

    // Event Conversations (AI chat history for event creation)
    // Path: eventConversations/{userId}/conversations/{conversationId}
    match /eventConversations/{userId}/conversations/{conversationId} {
      // Only the owner can access their conversations
      allow read, write: if isOwner(userId);
    }

    // ─────────── RULE FUNCTIONS ───────────
    function isValidProfileUpdate() {
      // Prevents tampering with system fields
      return (
        (!('email' in request.resource.data.keys()) || request.resource.data.email == resource.data.email)
        && (!('createdAt' in request.resource.data.keys()) || request.resource.data.createdAt == resource.data.createdAt)
      );
    }

    function isValidDuoInviteUpdate(userId) {
      // 1. Inviter creates or clears own invite
      let inviterSetsOrClears =
        request.auth.uid == userId &&
        (
          // Set new pending invite
          (request.resource.data.activeDuoInvite.status == 'pending'
            && request.resource.data.activeDuoInvite.tokenHash.matches('^[A-Za-z0-9_-]{10,}$'))
          ||
          // Clear invite
          (request.resource.data.activeDuoInvite == null)
        );

      // 2. Partner accepts valid invite
      let partnerAccepts =
        request.auth.uid != userId &&
        resource.data.activeDuoInvite.status == 'pending' &&
        resource.data.activeDuoInvite.tokenHash == request.resource.data.activeDuoInvite.tokenHash &&
        request.resource.data.activeDuoInvite.status == 'accepted';

      return inviterSetsOrClears || partnerAccepts;
    }

    // Deny all other access by default
  }
}
